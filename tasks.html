<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks - Earnzy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --primary-light: #d1fae5;
            --white: #ffffff;
            --light-gray: #f8fafc;
            --gray: #6b7280;
            --dark: #1f2937;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        body {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: var(--dark);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }
        
        /* Header Styles */
        header {
            background-color: var(--white);
            box-shadow: var(--shadow);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background-color: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 20px;
        }
        
        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .logo-text p {
            font-size: 14px;
            color: var(--gray);
        }
        
        .user-actions button {
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 12px;
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .user-actions button:hover {
            background-color: var(--primary-dark);
        }
        
        /* Page Header */
        .page-header {
            margin: 24px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--white);
        }
        
        .task-stats {
            display: flex;
            gap: 16px;
        }
        
        .stat-badge {
            background-color: var(--white);
            border-radius: 20px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            box-shadow: var(--shadow);
        }
        
        .stat-badge i {
            color: var(--primary);
        }
        
        /* Task Categories */
        .task-categories {
            margin: 24px 0;
        }
        
        .categories-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        
        .category-btn {
            background-color: var(--white);
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }
        
        .category-btn.active {
            background-color: var(--primary);
            color: var(--white);
        }
        
        /* Tasks Section */
        .tasks-section {
            margin: 24px 0;
        }
        
        .tasks-card {
            background-color: var(--white);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .view-all {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
            font-size: 14px;
        }
        
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }
        
        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 20px;
        }
        
        .task-details {
            flex: 1;
        }
        
        .task-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .task-details p {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 4px;
        }
        
        .task-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--gray);
        }
        
        .task-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .task-reward {
            font-weight: 700;
            color: var(--primary);
            font-size: 16px;
            margin-right: 16px;
        }
        
        .task-action button {
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        
        .task-action button.completed {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .task-action button:hover:not(.completed) {
            background-color: var(--primary-dark);
        }
        
        /* Progress Section */
        .progress-section {
            margin: 24px 0;
        }
        
        .progress-card {
            background-color: var(--white);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .progress-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .progress-value {
            font-size: 14px;
            color: var(--gray);
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            border-radius: 4px;
            width: 65%;
        }
        
        .progress-text {
            font-size: 12px;
            color: var(--gray);
            text-align: right;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--white);
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 12px 0;
            z-index: 100;
        }
        
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            transition: color 0.3s ease;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            .categories-container {
                justify-content: center;
            }
            
            .task-item {
                padding: 20px 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Earnzy</h1>
                        <p id="userName">Tasks & Rewards</p>
                    </div>
                </div>
                <div class="user-actions">
                    <button id="signOutBtn">
                        <i class="fas fa-sign-out-alt"></i> Sign Out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <div class="page-title">Daily Tasks</div>
            <div class="task-stats">
                <div class="stat-badge">
                    <i class="fas fa-check-circle"></i>
                    <span id="completedStats">0/0 Completed</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-coins"></i>
                    <span id="todayEarnings">+0 Today</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Task Categories -->
    <section class="task-categories">
        <div class="container">
            <div class="categories-container">
                <button class="category-btn active">All Tasks</button>
                <button class="category-btn">Daily</button>
                <button class="category-btn">Social</button>
                <button class="category-btn">Offers</button>
                <button class="category-btn">Surveys</button>
                <button class="category-btn">Games</button>
            </div>
        </div>
    </section>

    <!-- Progress Section -->
    <section class="progress-section">
        <div class="container">
            <div class="progress-card">
                <div class="progress-header">
                    <div class="progress-title">Daily Goal Progress</div>
                    <div class="progress-value" id="progressValue">0/500 coins</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Complete tasks to reach your daily goal</div>
            </div>
        </div>
    </section>

    <!-- Daily Tasks -->
    <section class="tasks-section">
        <div class="container">
            <div class="tasks-card">
                <div class="section-header">
                    <div class="section-title">Daily Tasks</div>
                    <a href="#" class="view-all">View All</a>
                </div>
                <div id="dailyTasksContainer">
                    <!-- Dynamic daily tasks will be loaded here -->
                </div>
            </div>
        </div>
    </section>

    <!-- Special Offers -->
    <section class="tasks-section">
        <div class="container">
            <div class="tasks-card">
                <div class="section-header">
                    <div class="section-title">Special Offers</div>
                    <a href="#" class="view-all">View All</a>
                </div>
                <div id="specialTasksContainer">
                    <!-- Dynamic special tasks will be loaded here -->
                </div>
            </div>
        </div>
    </section>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="container">
            <div class="nav-grid">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="tasks.html" class="nav-item active">
                    <i class="fas fa-tasks"></i>
                    <span>Tasks</span>
                </a>
                <a href="watch.html" class="nav-item">
                    <i class="fas fa-coins"></i>
                    <span>Earn</span>
                </a>
                <a href="withdraw.html" class="nav-item">
                    <i class="fas fa-wallet"></i>
                    <span>Wallet</span>
                </a>
                <a href="profile.html" class="nav-item">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://qwoqpwyjugfsiwlwvmlf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3b3Fwd3lqdWdmc2l3bHd2bWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzkzNDAsImV4cCI6MjA3NTA1NTM0MH0.36cfavBebNeF4SLuar3jUTRORYnhaOhc6A5xuF4HvLw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let userData = null;
        let tasks = [];
        let completedTasks = [];

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Show loading overlay
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // Check authentication
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            
            currentUser = session.user;
            
            // Load user data and tasks
            await loadUserData();
            await loadTasks();
            await loadCompletedTasks();
            
            // Update UI
            updateUI();
            
            // Hide loading overlay
            document.getElementById('loadingOverlay').style.display = 'none';
            
            // Setup event listeners
            setupEventListeners();
        }

        async function loadUserData() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;
                userData = data;
                
                // If user doesn't exist, create user record
                if (!userData) {
                    const { data: newUser, error: createError } = await supabase
                        .from('users')
                        .insert([
                            {
                                id: currentUser.id,
                                email: currentUser.email,
                                total_coins: 0,
                                earned_coins: 0,
                                daily_earnings: 0,
                                daily_goal: 500,
                                completed_tasks: [],
                                created_at: new Date().toISOString()
                            }
                        ])
                        .select()
                        .single();

                    if (createError) throw createError;
                    userData = newUser;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadTasks() {
            try {
                const { data, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: true });

                if (error) throw error;
                tasks = data || [];
            } catch (error) {
                console.error('Error loading tasks:', error);
                tasks = [];
            }
        }

        async function loadCompletedTasks() {
            try {
                const { data, error } = await supabase
                    .from('user_tasks')
                    .select('task_id')
                    .eq('user_id', currentUser.id);

                if (error) throw error;
                completedTasks = data.map(item => item.task_id) || [];
            } catch (error) {
                console.error('Error loading completed tasks:', error);
                completedTasks = [];
            }
        }

        function updateUI() {
            // Update user name
            document.getElementById('userName').textContent = userData?.name || userData?.email || 'Tasks & Rewards';
            
            // Update stats
            updateStats();
            
            // Update progress
            updateProgress();
            
            // Render tasks
            renderTasks();
        }

        function updateStats() {
            const completedCount = completedTasks.length;
            const totalTasks = tasks.length;
            const todayEarnings = userData?.daily_earnings || 0;
            
            document.getElementById('completedStats').textContent = `${completedCount}/${totalTasks} Completed`;
            document.getElementById('todayEarnings').textContent = `+${todayEarnings} Today`;
        }

        function updateProgress() {
            const dailyGoal = userData?.daily_goal || 500;
            const todayEarnings = userData?.daily_earnings || 0;
            const progressPercentage = Math.min((todayEarnings / dailyGoal) * 100, 100);
            
            document.getElementById('progressValue').textContent = `${todayEarnings}/${dailyGoal} coins`;
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;
            
            const remaining = dailyGoal - todayEarnings;
            const tasksNeeded = Math.ceil(remaining / 50); // Assuming average task gives 50 coins
            document.getElementById('progressText').textContent = 
                `Complete ${tasksNeeded} more tasks to reach your daily goal`;
        }

        function renderTasks() {
            renderTaskSection('daily', 'dailyTasksContainer');
            renderTaskSection('special', 'specialTasksContainer');
        }

        function renderTaskSection(category, containerId) {
            const container = document.getElementById(containerId);
            const filteredTasks = tasks.filter(task => task.category === category);
            
            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-tasks text-3xl mb-2"></i>
                        <p>No tasks available</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredTasks.map(task => {
                const isCompleted = completedTasks.includes(task.id);
                const completedCount = task.completed_count || 0;
                
                return `
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-icon" style="background-color: ${task.color || '#10b981'};">
                                <i class="${task.icon || 'fas fa-tasks'}"></i>
                            </div>
                            <div class="task-details">
                                <h3>${task.title}</h3>
                                <p>${task.description}</p>
                                <div class="task-meta">
                                    <span><i class="fas fa-clock"></i> ${task.duration} min</span>
                                    <span><i class="fas fa-users"></i> ${completedCount.toLocaleString()} completed</span>
                                </div>
                            </div>
                        </div>
                        <div class="task-reward">+${task.reward}</div>
                        <div class="task-action">
                            <button 
                                class="${isCompleted ? 'completed' : ''}" 
                                ${isCompleted ? 'disabled' : ''}
                                onclick="startTask('${task.id}', ${task.reward})"
                            >
                                ${isCompleted ? 'Completed' : 'Start'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function startTask(taskId, reward) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                // Check if task is already completed
                if (completedTasks.includes(taskId)) {
                    alert('Task already completed!');
                    document.getElementById('loadingOverlay').style.display = 'none';
                    return;
                }

                // Simulate task completion (in real app, this would have actual task flow)
                setTimeout(async () => {
                    await completeTask(taskId, reward);
                }, 2000);

            } catch (error) {
                console.error('Error starting task:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Error starting task. Please try again.');
            }
        }

        async function completeTask(taskId, reward) {
            try {
                // Update user coins
                const { error: userError } = await supabase
                    .from('users')
                    .update({
                        total_coins: (userData.total_coins || 0) + reward,
                        earned_coins: (userData.earned_coins || 0) + reward,
                        daily_earnings: (userData.daily_earnings || 0) + reward,
                        completed_tasks: [...(userData.completed_tasks || []), taskId]
                    })
                    .eq('id', currentUser.id);

                if (userError) throw userError;

                // Record task completion
                const { error: taskError } = await supabase
                    .from('user_tasks')
                    .insert([
                        {
                            user_id: currentUser.id,
                            task_id: taskId,
                            reward: reward,
                            completed_at: new Date().toISOString()
                        }
                    ]);

                if (taskError) throw taskError;

                // Update task completion count
                const task = tasks.find(t => t.id === taskId);
                const { error: updateTaskError } = await supabase
                    .from('tasks')
                    .update({
                        completed_count: (task.completed_count || 0) + 1
                    })
                    .eq('id', taskId);

                if (updateTaskError) throw updateTaskError;

                // Add earning record
                const { error: earningError } = await supabase
                    .from('earnings')
                    .insert([
                        {
                            user_id: currentUser.id,
                            type: 'task',
                            coins: reward,
                            task_id: taskId,
                            created_at: new Date().toISOString()
                        }
                    ]);

                if (earningError) throw earningError;

                // Reload data
                await loadUserData();
                await loadCompletedTasks();
                await loadTasks();
                
                // Update UI
                updateUI();
                
                document.getElementById('loadingOverlay').style.display = 'none';
                alert(`Task completed! ${reward} coins have been added to your wallet.`);

            } catch (error) {
                console.error('Error completing task:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Error completing task. Please try again.');
            }
        }

        function setupEventListeners() {
            // Category buttons
            const categoryButtons = document.querySelectorAll('.category-btn');
            categoryButtons.forEach(button => {
                button.addEventListener('click', function() {
                    categoryButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    // Implement category filtering if needed
                });
            });

            // Sign out button
            document.getElementById('signOutBtn').addEventListener('click', async function() {
                document.getElementById('loadingOverlay').style.display = 'flex';
                try {
                    const { error } = await supabase.auth.signOut();
                    if (!error) {
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('Sign out error:', error);
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
