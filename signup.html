document.addEventListener('DOMContentLoaded', async function() {
    // Initialize Supabase
    const supabaseUrl = 'https://qwoqpwyjugfsiwlwvmlf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3b3Fwd3lqdWdmc2l3bHd2bWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzkzNDAsImV4cCI6MjA3NTA1NTM0MH0.36cfavBebNeF4SLuar3jUTRORYnhaOhc6A5xuF4HvLw';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Check if already logged in
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
        window.location.href = 'dashboard.html';
        return;
    }

    // Handle form submission
    document.getElementById('signupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const referralCode = document.getElementById('referralCode').value;
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');

        // Show loading
        loading.classList.remove('hidden');
        errorMessage.classList.add('hidden');

        try {
            // Generate unique referral code
            const userReferralCode = Math.random().toString(36).substring(2, 8).toUpperCase();

            // Create auth user
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email: email,
                password: password,
            });

            if (authError) throw authError;

            // Create user profile (WITHOUT name field to avoid schema error)
            const { error: profileError } = await supabase
                .from('users')
                .insert({
                    id: authData.user.id,
                    email: email,
                    referral_code: userReferralCode,
                    referred_by: referralCode || null,
                    total_coins: 0,
                    earned_coins: 0,
                    withdrawn_coins: 0,
                    daily_streak: 0,
                    last_checkin: null
                    // name field temporarily removed to fix schema error
                });

            if (profileError) throw profileError;

            // Process referral if code provided (simplified)
            if (referralCode) {
                try {
                    // Find inviter by referral code
                    const { data: inviter, error: inviterError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('referral_code', referralCode)
                        .single();

                    if (!inviterError && inviter) {
                        // Add referral record
                        await supabase
                            .from('referrals')
                            .insert({
                                inviter_id: inviter.id,
                                invitee_id: authData.user.id,
                                bonus_given: true
                            });

                        // Give bonus coins (250 each)
                        await supabase
                            .from('users')
                            .update({
                                total_coins: (inviter.total_coins || 0) + 250,
                                earned_coins: (inviter.earned_coins || 0) + 250
                            })
                            .eq('id', inviter.id);

                        await supabase
                            .from('users')
                            .update({
                                total_coins: 250,
                                earned_coins: 250
                            })
                            .eq('id', authData.user.id);
                    }
                } catch (referralError) {
                    console.error('Referral processing error:', referralError);
                    // Don't throw error - continue with signup
                }
            }

            // SUCCESS - Redirect to login page (NOT dashboard)
            showNotification('Account created successfully! Please login with your credentials.', 'success');
            
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 3000);

        } catch (error) {
            console.error('Signup error:', error);
            errorMessage.textContent = error.message || 'Failed to create account. Please try again.';
            errorMessage.classList.remove('hidden');
        } finally {
            loading.classList.add('hidden');
        }
    });

    // Show notification function
    function showNotification(message, type) {
        const notification = document.getElementById('notification');
        if (notification) {
            notification.textContent = message;
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-transform duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            notification.classList.remove('hidden');

            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
    }
});
